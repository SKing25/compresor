{% extends "base.html" %}

{% block title %}Compresi√≥n por Lotes{% endblock %}

{% block content %}
<div class="simple-container">
    <h2 class="mb-4">Comprimir Archivos WAV</h2>
    <form id="batchForm" enctype="multipart/form-data">
        <label for="files" class="form-label">Selecciona archivos WAV:</label>
        <input type="file" class="form-control mb-3" id="files" name="files" accept=".wav" multiple required>

        <label for="bitrate" class="form-label">Bitrate:</label>
        <select class="form-select mb-3" id="bitrate" name="bitrate">
            <option value="128k" selected>128k</option>
            <option value="192k">192k</option>
            <option value="256k">256k</option>
        </select>

        <label for="quality" class="form-label">Calidad:</label>
        <select class="form-select mb-3" id="quality" name="quality">
            <option value="medium" selected>Media</option>
            <option value="high">Alta</option>
            <option value="low">Baja</option>
        </select>

        <button type="submit" class="btn btn-primary w-100">Comprimir</button>
    </form>

    <div id="progress" class="mt-3" style="display:none;">
        <div class="progress">
            <div id="progressBar" class="progress-bar" style="width:0%"></div>
        </div>
    </div>

    <div id="results" class="mt-3"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('batchForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const progress = document.getElementById('progress');
    const results = document.getElementById('results');

    progress.style.display = 'block';
    results.innerHTML = '';

    fetch('/batch_upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progress.style.display = 'none';

        if (data.results) {
            let html = '<h5>Resultados:</h5><ul>';
            data.results.forEach(result => {
                if (result.success) {
                    html += `<li>${result.filename} - <a href="${result.download_url}">Descargar</a></li>`;
                } else {
                    html += `<li>${result.filename} - Error: ${result.error}</li>`;
                }
            });
            html += '</ul>';
            results.innerHTML = html;
        }
    })
    .catch(error => {
        progress.style.display = 'none';
        results.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    });
});
</script>
{% endblock %}
